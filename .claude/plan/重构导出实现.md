# 重构导出实现 - Canvas帧捕获方案

## 项目背景

重构export包的实现，完全替换@webav/av-cliper的Combinator实现，改为基于canvas包的Director.seek()进行帧捕获，最终通过WebCodecs API编码为视频。

## 技术方案

- **方案选择**：方案3 - WebCodecs + WebAV高性能方案
- **核心思路**：Director.seek() → Canvas渲染 → 帧捕获 → WebAV编码器 → MP4输出
- **性能目标**：1080p@30fps，硬件加速编码
- **兼容性**：保持现有API接口不变

## 核心架构

```
┌─────────────────┐    ┌──────────────┐    ┌─────────────────┐
│   Director      │───▶│   Canvas     │───▶│   帧捕获器       │
│  (seek控制)      │    │   (PIXI渲染)  │    │ (ImageData提取)  │
└─────────────────┘    └──────────────┘    └─────────────────┘
                                                        │
┌─────────────────┐    ┌──────────────┐    ┌─────────────────┐
│   视频输出       │◀───│ WebAV编码器   │◀───│   帧缓冲队列     │
│  (Blob/下载)     │    │ (H.264/H.265) │    │ (内存管理)       │
└─────────────────┘    └──────────────┘    └─────────────────┘
```

## 实施步骤

### 阶段1：基础架构重建

1. ✅ 分析现有export包结构和依赖
2. 设计新的CanvasExporter核心类
3. 实现帧捕获和缓冲机制
4. 集成WebAV编码器

### 阶段2：导出流程整合

5. 实现主导出流程
6. 实现进度追踪和事件系统
7. 重构导出管理器和公共API

### 阶段3：类型系统和测试

8. 更新类型定义和接口
9. 测试和验证导出功能

## 关键文件

- `packages/export/src/core/CanvasExporter.ts` - 主要导出器类
- `packages/export/src/core/FrameCapture.ts` - 帧捕获实现
- `packages/export/src/core/FrameBuffer.ts` - 帧缓冲管理
- `packages/export/src/encoders/WebAVEncoder.ts` - WebAV编码器集成
- `packages/export/src/types/index.ts` - 类型定义更新

## 技术要点

- 利用`director.stage.app.canvas`获取Canvas DOM
- 通过`director.seek(time)`精确控制帧时间点
- 使用`canvas.getContext('2d').getImageData()`捕获帧数据
- 集成@webav/av-cliper的编码器API
- 30fps精确时控（33.33ms间隔）
- 内存优化和缓冲区管理

## 性能目标

- 分辨率：1920x1080 (1080p)
- 帧率：30fps
- 编码：H.264硬件加速
- 内存：可控的帧缓冲区，避免溢出
